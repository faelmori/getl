{
  "sourceType": "sqlserver",
  "sourceConnectionString": "sqlserver://sankhya:azsxdc@localhost:1433?database=sankhya_prod&encrypt=disable&trustservercertificate=true",
  "destinationType": "postgres",
  "destinationConnectionString": "postgres://kubex_adm:SyVLNzyJft@localhost:5432/kubex_db?sslmode=disable",
  "destinationTable": "erp_prod_batch_price",
  "sqlQuery": "WITH\n    TIPO_FAST AS (\n        SELECT\n            O.VALOR\n             , O.OPCAO\n        FROM\n            [sankhya].TDDCAM C (NOLOCK)\n                INNER JOIN\n            [sankhya].TDDOPC O (NOLOCK)\n            ON C.NUCAMPO = O.NUCAMPO\n        WHERE\n            C.NOMETAB = 'TGFTAB'\n          AND C.NOMECAMPO= 'AD_TIPO_FAST'\n          AND O.VALOR  = 'D'\n    )\n   , PRICETABS AS (\n    SELECT\n        T.CODTAB\n         , T.DTVIGOR\n         , T.CODREG\n         , T.DTALTER\n         , T.PERCENTUAL\n         , T.FORMULA\n         , T.CODTABORIG\n         , T.NUTAB\n         , T.JAPE_ID\n         , T.AD_MOBILIDADE\n         , T.UTILIZADECCUSTO\n         , T.AD_TIPO_FAST AS COD_TIPO_FAST\n         , F.OPCAO AS DESCR_TIPO_FAST\n    FROM\n        [sankhya].TGFTAB T (NOLOCK)\n            INNER JOIN\n        TIPO_FAST F\n        ON T.AD_TIPO_FAST = F.VALOR\n)\n   , PRICEREF AS (\n    SELECT\n        TOB.NUTAB\n         , TOB.CODTAB\n         , TOB.DESCR_TIPO_FAST\n         , N'TABELA PADR\u00C3O SITE (NUTAB ' + CAST(TOB.NUTAB AS NVARCHAR) + ' - ' + 'TIPO PRE\u00C7O ' + TOB.DESCR_TIPO_FAST + ')' AS DESCRTAB\n    FROM\n        PRICETABS TOB\n    WHERE\n        TOB.DTVIGOR = (\n            SELECT\n                MAX(T.DTVIGOR)\n            FROM\n                [sankhya].TGFTAB T (NOLOCK)\n            WHERE\n                T.CODTAB = TOB.CODTAB\n        )\n)\n   , TABCHECK AS (\n    SELECT\n        E.CODPROD\n         , E.NUTAB\n         , P.CODTAB\n         , P.DESCRTAB\n         , P.DESCR_TIPO_FAST\n    FROM\n        [sankhya].TGFEXC E (NOLOCK)\n            INNER JOIN\n        PRICEREF P\n        ON E.NUTAB = P.NUTAB\n)\n   , MARKA AS (\n    SELECT\n        M.CODIGO\n         , M.DESCRICAO\n         , M.AD_RELATORIODIARIO\n         , M.AD_FAST\n         , M.AD_FASTREF\n    FROM\n        [sankhya].TGFMAR M (NOLOCK)\n    WHERE\n        M.AD_FAST = 'S'\n      AND M.AD_FASTREF IN('C', 'R')\n)\n   , PRODUTOS AS (\n    SELECT\n        P.*\n         , M.AD_FASTREF\n    FROM\n        [sankhya].TGFPRO P (NOLOCK)\n            INNER JOIN\n        MARKA M\n        ON P.CODMARCA = M.CODIGO\n    WHERE\n        P.ATIVO = 'S'\n)\n   , PARCIAL_A AS (\n    SELECT\n        LTRIM(RTRIM(CAST(P.CODPROD AS VARCHAR))) AS ProductId\n         , P.DESCRPROD as ProductName\n         , N.DESCRTAB AS PriceTableName\n         , [sankhya].SNK_GET_PRECO(N.NUTAB, P.CODPROD, CURRENT_TIMESTAMP) AS VLRUNIT\n         , N.DESCR_TIPO_FAST\n         , P.AD_FASTREF\n         , P.CODPROD\n         , N.CODTAB\n         , N.NUTAB\n    FROM\n        PRODUTOS P\n            INNER JOIN\n        TABCHECK N\n        ON P.CODPROD = N.CODPROD\n    WHERE\n        P.ATIVO = 'S'\n      AND P.AD_FASTREF = 'C'\n)\n   , PARCIAL_T AS (\n    SELECT\n        LTRIM(RTRIM(P.REFFORN)) AS ProductId\n         , P.DESCRPROD as ProductName\n         , N.DESCRTAB AS PriceTableName\n         , [sankhya].SNK_GET_PRECO(N.NUTAB, P.CODPROD, CURRENT_TIMESTAMP) AS VLRUNIT\n         , N.DESCR_TIPO_FAST\n         , P.AD_FASTREF\n         , P.CODPROD\n         , N.CODTAB\n         , N.NUTAB\n    FROM\n        PRODUTOS P\n            INNER JOIN\n        TABCHECK N\n        ON P.CODPROD = N.CODPROD\n    WHERE\n        P.ATIVO = 'S'\n      AND P.AD_FASTREF = 'R'\n)\n   , PREBATCH AS (\n    SELECT\n        PA.ProductId\n         , PA.ProductName\n         , PA.PriceTableName\n         , REPLACE(REPLACE(CONVERT(VARCHAR, FORMAT(ROUND(PA.VLRUNIT, 2), 'N2'), 2), '.', ''), ',', '') AS ListPrice\n         , REPLACE(REPLACE(CONVERT(VARCHAR, FORMAT(ROUND(PA.VLRUNIT, 2), 'N2'), 2), '.', ''), ',', '') AS SalePrice\n         , PA.DESCR_TIPO_FAST\n         , PA.AD_FASTREF\n         , PA.VLRUNIT\n         , PA.CODPROD\n         , PA.CODTAB\n         , PA.NUTAB\n    FROM\n        PARCIAL_A PA\n    UNION ALL\n    SELECT\n        PT.ProductId\n         , PT.ProductName\n         , PT.PriceTableName\n         , REPLACE(REPLACE(CONVERT(VARCHAR, FORMAT(ROUND(PT.VLRUNIT, 2), 'N2'), 2), '.', ''), ',', '') AS ListPrice\n         , REPLACE(REPLACE(CONVERT(VARCHAR, FORMAT(ROUND(PT.VLRUNIT, 2), 'N2'), 2), '.', ''), ',', '') AS SalePrice\n         , PT.DESCR_TIPO_FAST\n         , PT.AD_FASTREF\n         , PT.VLRUNIT\n         , PT.CODPROD\n         , PT.CODTAB\n         , PT.NUTAB\n    FROM\n        PARCIAL_T PT\n)\n   , PRERES AS (\n    SELECT\n        PRE.ProductId\n         , PRE.ProductName\n         , PRE.PriceTableName\n         , PRE.ListPrice\n         , PRE.SalePrice\n         , PRE.DESCR_TIPO_FAST\n         , PRE.VLRUNIT\n         , PRE.CODTAB AS PRECODTAB\n         , PRE.NUTAB\n         , PRO.*\n    FROM\n        PRODUTOS PRO\n            INNER JOIN\n        PREBATCH PRE\n        ON PRO.CODPROD = PRE.CODPROD\n)\n   , PREDESC AS (\n    SELECT\n        D1.NUPROMOCAO\n         , D1.CODPROD\n         , D1.GRUPODESCPROD\n         , D1.DTFINAL\n         , X1.QTDE\n         , X1.PERCDESC\n         , X1.TIPDESC\n         , (\n        CASE WHEN (\n            ISNULL(P2.GRUPODESCPROD, '#') = ISNULL(D1.GRUPODESCPROD, '@')\n                AND ISNULL(P2.CODPROD, -1) = ISNULL(D1.CODPROD, -2)\n                AND ISNULL(P2.PRECODTAB, -1) = ISNULL(D1.CODTAB, -2)\n            ) THEN\n                 'QUATRO CAMPOS'\n             WHEN (\n                 ISNULL(P2.CODPROD, -1) = ISNULL(D1.CODPROD, -2)\n                     AND ISNULL(P2.PRECODTAB, -1) = ISNULL(D1.CODTAB, -2)\n                     AND (D1.GRUPODESCPROD IS NULL OR D1.GRUPODESCPROD = '***************')\n                 ) THEN\n                 'CODPRO E CODTAB'\n             WHEN (\n                 ISNULL(P2.GRUPODESCPROD, '#') = ISNULL(D1.GRUPODESCPROD, '@')\n                     AND ISNULL(P2.PRECODTAB, -1) = ISNULL(D1.CODTAB, -2)\n                     AND (D1.CODPROD IS NULL)\n                 ) THEN\n                 'GRUPO E CODTAB'\n             WHEN (\n                 ISNULL(P2.GRUPODESCPROD, '#') = ISNULL(D1.GRUPODESCPROD, '@')\n                     AND ISNULL(P2.CODPROD, -1) = ISNULL(D1.CODPROD, -2)\n                     AND (D1.CODTAB IS NULL)\n                 ) THEN\n                 'GRUPO E CODPROD'\n             WHEN (\n                 ISNULL(P2.PRECODTAB, -1) = ISNULL(D1.CODTAB, -2)\n                     AND (D1.CODPROD IS NULL\n                     AND (D1.GRUPODESCPROD IS NULL OR D1.GRUPODESCPROD = '***************'))\n                 ) THEN\n                 'CODTAB'\n             WHEN (\n                 ISNULL(P2.CODPROD, -1) = ISNULL(D1.CODPROD, -2)\n                     AND (D1.CODTAB IS NULL\n                     AND (D1.GRUPODESCPROD IS NULL OR D1.GRUPODESCPROD = '***************'))\n                 ) THEN\n                 'CODPROD'\n             WHEN (\n                 ISNULL(P2.GRUPODESCPROD, '#') = ISNULL(D1.GRUPODESCPROD, '@')\n                     AND (D1.CODTAB IS NULL\n                     AND D1.CODPROD IS NULL)\n                 ) THEN\n                 'GRUPO'\n             ELSE\n                 'FALSE'\n            END\n        ) AS FLAG_BATCH\n    FROM\n        [sankhya].TGFDES D1 (NOLOCK)\n            INNER JOIN\n        [sankhya].TGFDPQ X1 (NOLOCK)\n        ON D1.NUPROMOCAO = X1.NUPROMOCAO\n            INNER JOIN\n        PRERES P2\n        ON P2.CODPROD = D1.CODPROD\n)\n   , BATCH AS (\n    SELECT\n        P.ProductId\n         , D.NUPROMOCAO\n         , Q.QTDE AS MinimumBatchSize\n         , (\n        ISNULL(\n                (\n                    SELECT\n                        MIN(D1.QTDE)\n                    FROM\n                        PREDESC D1\n                            INNER JOIN\n                        [sankhya].TGFPRO P1 (NOLOCK)\n                        ON (\n                            D1.CODPROD = P1.CODPROD\n                                OR D1.GRUPODESCPROD = P1.GRUPODESCPROD\n                            )\n                    WHERE\n                        P1.CODPROD = P.CODPROD\n                      AND D1.QTDE > Q.QTDE\n                      AND D1.NUPROMOCAO = D.NUPROMOCAO\n                ), 1001\n        ) - 1\n        ) AS MaximumBatchSize\n         , (\n        CASE WHEN Q.TIPDESC = 'P' THEN\n                 (P.VLRUNIT - (P.VLRUNIT * (Q.PERCDESC \/ 100)))\n             ELSE\n                 Q.PERCDESC\n            END\n        ) AS UnitaryPriceForBatch\n         , 'false' AS BatchDisabled\n         , Q.NUVERSAO\n         , F.BATCHID\n         , F.STATUS\n         , F.MSG\n         , F.DTALTER\n         , (\n        CASE WHEN D.DTFINAL >= DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0) THEN\n                 'VALID'\n             ELSE\n                 CASE WHEN F.STATUS = 'A' THEN\n                          'REMOVE'\n                      ELSE\n                          'INVALID'\n                     END\n            END\n        ) AS FLAG\n         , P.CODPROD\n         , Q.TIPDESC\n         , Q.PERCDESC\n         , P.PRECODTAB AS CODTAB\n         , P.NUTAB\n         , D.CODEMP\n         , D.DTINICIAL\n         , D.DTFINAL\n         , P.DESCR_TIPO_FAST\n         , DP.FLAG_BATCH\n         , D.CODTAB AS DESCODTAB\n         , D.GRUPODESCPROD\n    FROM\n        [sankhya].TGFDES D (NOLOCK)\n            INNER JOIN\n        [sankhya].TGFDPQ Q (NOLOCK)\n        ON D.NUPROMOCAO = Q.NUPROMOCAO\n            INNER JOIN\n        PREDESC DP\n        ON D.NUPROMOCAO = DP.NUPROMOCAO\n            AND D.CODPROD = DP.CODPROD\n            AND Q.QTDE = DP.QTDE\n            INNER JOIN\n        PRERES P\n        ON D.CODPROD = P.CODPROD\n            LEFT JOIN\n        [sankhya].AD_ESCFASTSYNC F (NOLOCK)\n        ON D.NUPROMOCAO = F.NUPROMOCAO\n            AND Q.QTDE = F.QTDE\n            AND F.STATUS != 'I'\n    WHERE\n        ISNULL(D.NUVERSAO, 0) = (\n            SELECT\n                MAX(ISNULL(S.NUVERSAO, 0))\n            FROM\n                [sankhya].TGFDES S (NOLOCK)\n            WHERE\n                S.NUPROMOCAO = D.NUPROMOCAO\n        )\n    --AND DP.FLAG_BATCH != 'FALSE'\n)\n   , BATCH_R AS (\n    SELECT\n        B.ProductId\n         , B.MinimumBatchSize\n         , B.MaximumBatchSize\n         , REPLACE(REPLACE(CONVERT(VARCHAR, FORMAT(ROUND(B.UnitaryPriceForBatch, 2), 'N2'), 2), '.', ''), ',', '') AS ListPrice\n         , B.BatchDisabled\n         , B.BATCHID\n         , B.STATUS\n         , B.MSG\n         , B.DTALTER\n         , B.FLAG\n         , B.CODPROD\n         , B.TIPDESC\n         , B.PERCDESC\n         , B.NUPROMOCAO\n         , B.CODTAB\n         , B.NUTAB\n         , B.CODEMP\n         , B.DTINICIAL\n         , B.DTFINAL\n         , B.DESCR_TIPO_FAST\n         , B.FLAG_BATCH\n         , B.DESCODTAB\n         , B.GRUPODESCPROD\n    FROM\n        BATCH B\n    WHERE\n        B.FLAG_BATCH != 'FALSE'\n)\n\nSELECT\n    R.ProductId\n     , R.MinimumBatchSize\n     , R.MaximumBatchSize\n     , R.ListPrice\n     , R.BatchDisabled\n     , R.BATCHID\n     , R.STATUS\n     , R.MSG\n     , R.DTALTER\n     , R.FLAG\n     , R.CODPROD\n     , R.TIPDESC\n     , R.PERCDESC\n     , R.NUPROMOCAO\n     , R.CODTAB\n     , R.NUTAB\n     , R.CODEMP\n     , R.DTINICIAL\n     , R.DTFINAL\n     , R.DESCR_TIPO_FAST\n     , R.FLAG_BATCH\n     , R.DESCODTAB\n     , R.GRUPODESCPROD\nFROM\n    BATCH_R R\n\n\n",
  "kafkaURL": "",
  "kafkaTopic": "",
  "kafkaGroupID": "",
  "primaryKey": "ProductId",
  "updateKey": "ProductId"
}


